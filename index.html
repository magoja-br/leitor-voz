<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor Neural MP3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f4f6f8; text-align: center; }
        .box { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 700px; margin: 0 auto; }
        textarea { width: 100%; height: 120px; padding: 15px; border: 2px solid #e1e4e8; border-radius: 8px; margin: 15px 0; font-size: 16px; box-sizing: border-box; resize: vertical; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        button { flex: 1; padding: 15px; border: none; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; font-size: 16px; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        .play { background: #007bff; }
        .mp3 { background: #dc3545; } /* Vermelho para MP3 */
        .file { background: #6c757d; }
        #status { padding: 15px; background: #e2e6ea; border-radius: 8px; color: #495057; font-weight: bold; margin-top: 15px; }
    </style>
</head>
<body>

<div class="box">
    <h2>üó£Ô∏è Leitor Neural + MP3</h2>
    
    <label for="fileInput" style="display:block; margin-bottom:10px; cursor:pointer; color:#007bff; font-weight:bold;">
        üìÇ Clique aqui para abrir arquivo de texto
    </label>
    <input type="file" id="fileInput" accept=".txt,.md" style="display:none">

    <textarea id="texto">Este √© o teste final. Agora o sistema converte para MP3 de verdade usando o LameJS.</textarea>
    
    <div class="btn-group">
        <button class="play" onclick="tocar()">‚ñ∂Ô∏è Ouvir</button>
        <button class="mp3" onclick="baixarMP3()">‚¨áÔ∏è Baixar MP3</button>
    </div>

    <div id="status">‚è≥ Aguardando...</div>
    <audio id="player" controls style="display:none; width:100%; margin-top:10px;"></audio>
</div>

<script type="module">
    // --- CONFIGURA√á√ÉO DE LINKS (USANDO UNPKG - MAIS EST√ÅVEL) ---
    const IMPORTER_URL = "https://unpkg.com/piper-wasm-web@1.0.4/index.js";
    const WASM_URL     = "https://unpkg.com/piper-wasm-web@1.0.4/piper_wasm.wasm";
    
    // Voz (HuggingFace)
    const VOZ_ONNX = "https://huggingface.co/rhasspy/piper-voices/resolve/main/pt/pt_BR/faber/medium/pt_BR-faber-medium.onnx?download=true";
    const VOZ_JSON = "https://huggingface.co/rhasspy/piper-voices/resolve/main/pt/pt_BR/faber/medium/pt_BR-faber-medium.onnx.json?download=true";

    let piper = null;
    const statusDiv = document.getElementById('status');

    function log(msg) { statusDiv.innerText = msg; console.log(msg); }

    // --- FUN√á√ÉO MAGICA: CONVERTE √ÅUDIO RAW PARA MP3 ---
    function converterParaMP3(rawAudio, sampleRate) {
        log("üîÑ Convertendo para MP3 (Pode demorar uns segundos)...");
        const encoder = new lamejs.Mp3Encoder(1, sampleRate, 128); // Mono, Hz, 128kbps
        
        // Converte Float32 (Piper) para Int16 (LameJS)
        const samples = new Int16Array(rawAudio.length);
        for (let i = 0; i < rawAudio.length; i++) {
            // Multiplica por 32767 para transformar decimal em inteiro
            samples[i] = rawAudio[i] < 0 ? rawAudio[i] * 0x8000 : rawAudio[i] * 0x7FFF;
        }

        const mp3Data = [];
        const mp3Part = encoder.encodeBuffer(samples);
        if (mp3Part.length > 0) mp3Data.push(mp3Part);
        
        const mp3End = encoder.flush();
        if (mp3End.length > 0) mp3Data.push(mp3End);

        return new Blob(mp3Data, { type: 'audio/mp3' });
    }

    async function iniciar() {
        try {
            log("üì° Conectando (Vers√£o UNPKG)...");
            
            // Importa√ß√£o Din√¢mica
            const modulo = await import(IMPORTER_URL);
            const createPiper = modulo.createPiper;

            // Cache Inteligente
            const cache = await caches.open('piper-mp3-v1');
            async function getFile(url) {
                let r = await cache.match(url);
                if(r) return r;
                log("‚¨áÔ∏è Baixando Voz (35MB)...");
                r = await fetch(url);
                if(!r.ok) throw new Error("Falha download");
                await cache.put(url, r.clone());
                return r;
            }

            const bVoz = await (await getFile(VOZ_ONNX)).blob();
            const bJson = await (await getFile(VOZ_JSON)).blob();

            log("‚öôÔ∏è Ligando Motor...");
            piper = await createPiper({
                model: URL.createObjectURL(bVoz),
                config: URL.createObjectURL(bJson),
                piperWasmUrl: WASM_URL
            });

            log("‚úÖ PRONTO! Escolha Ouvir ou MP3.");

        } catch (e) { log("‚ùå ERRO: " + e.message); }
    }

    // --- A√á√ïES DOS BOT√ïES ---

    window.tocar = async function() {
        if(!piper) { alert("Carregando..."); return; }
        const txt = document.getElementById('texto').value;
        log("üîä Gerando...");
        
        // Pede o √°udio ao Piper
        const out = await piper.speak(txt);
        
        const blob = new Blob([out.rawHtml], { type: 'audio/wav' });
        const url = URL.createObjectURL(blob);
        const p = document.getElementById('player');
        p.style.display = 'block';
        p.src = url;
        p.play();
        log("‚ñ∂Ô∏è Tocando");
    }

    window.baixarMP3 = async function() {
        if(!piper) { alert("Carregando..."); return; }
        const txt = document.getElementById('texto').value;
        if(txt.length > 500) log("‚ö†Ô∏è Texto longo! A convers√£o vai demorar...");
        
        log("üîä Gerando √°udio bruto...");
        const out = await piper.speak(txt); // Gera o √°udio
        
        // O Piper retorna 'rawAudio' que s√£o os dados puros (Float32)
        // A frequ√™ncia padr√£o dessas vozes costuma ser 22050Hz
        const blobMP3 = converterParaMP3(out.rawAudio, 22050);
        
        log("üíæ Baixando MP3...");
        const url = URL.createObjectURL(blobMP3);
        const a = document.createElement('a');
        a.href = url;
        a.download = "audio-piper.mp3";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        log("‚úÖ Download MP3 Iniciado!");
    }

    // Input de Arquivo
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const f = e.target.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = function(e) { document.getElementById('texto').value = e.target.result; };
        r.readAsText(f);
    });

    iniciar();
</script>

</body>
</html>