<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor Neural V3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #eef2f5; text-align: center; }
        .box { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin: 10px 0; }
        button { padding: 15px; width: 45%; margin: 5px; border: none; border-radius: 8px; font-weight: bold; color: white; font-size: 16px; }
        .play { background: #007bff; }
        .down { background: #28a745; }
        #status { margin-top: 20px; font-weight: bold; color: #333; padding: 10px; background: #fff3cd; border-radius: 5px; border: 1px solid #ffeeba; }
    </style>
</head>
<body>

<div class="box">
    <h2>üó£Ô∏è Teste Final</h2>
    
    <textarea id="texto">Ol√°! Se voc√™ est√° ouvindo isso, o sistema funcionou no seu Android.</textarea>
    
    <div>
        <button class="play" onclick="tocar()">‚ñ∂Ô∏è Ouvir</button>
        <button class="down" onclick="baixar()">‚¨áÔ∏è Baixar</button>
    </div>

    <div id="status">‚è≥ Aguardando Scripts...</div>
    <audio id="player" controls style="display:none; width:100%; margin-top:10px;"></audio>
</div>

<script type="module">
    // Vari√°veis Globais
    let piper = null;
    const statusDiv = document.getElementById('status');
    
    // URLs (Direto da Nuvem)
    const MODULO_JS = "https://cdn.jsdelivr.net/npm/piper-wasm-web@1.0.4/index.js";
    const VOZ_ONNX = "https://huggingface.co/rhasspy/piper-voices/resolve/main/pt/pt_BR/faber/medium/pt_BR-faber-medium.onnx?download=true";
    const VOZ_JSON = "https://huggingface.co/rhasspy/piper-voices/resolve/main/pt/pt_BR/faber/medium/pt_BR-faber-medium.onnx.json?download=true";
    const MOTOR_WASM = "https://cdn.jsdelivr.net/npm/piper-wasm-web@1.0.4/piper_wasm.wasm";

    function log(msg) {
        statusDiv.innerText = msg;
        console.log(msg);
    }

    // Fun√ß√£o Principal que Inicia Tudo
    async function iniciarSistema() {
        try {
            log("üì° Conectando √† internet...");
            
            // 1. Importa√ß√£o Din√¢mica (Para n√£o travar a tela branca)
            const modulo = await import(MODULO_JS);
            const createPiper = modulo.createPiper;

            log("üì• Verificando Cache de Voz...");
            
            // 2. Prepara Cache
            const cache = await caches.open('piper-test-v1');
            
            // Fun√ß√£o auxiliar de download
            async function pegarArquivo(url, nome) {
                let resp = await cache.match(url);
                if (resp) {
                    log(`‚úÖ ${nome} carregado do celular.`);
                    return resp;
                }
                log(`‚¨áÔ∏è Baixando ${nome} da nuvem...`);
                resp = await fetch(url);
                if (!resp.ok) throw new Error(`Falha ao baixar ${nome}`);
                await cache.put(url, resp.clone());
                return resp;
            }

            // 3. Carrega arquivos
            const blobVoz = await (await pegarArquivo(VOZ_ONNX, "Voz")).blob();
            const blobJson = await (await pegarArquivo(VOZ_JSON, "Config")).blob();

            log("‚öôÔ∏è Ligando Motor Neural...");

            // 4. Cria o Piper
            piper = await createPiper({
                model: URL.createObjectURL(blobVoz),
                config: URL.createObjectURL(blobJson),
                piperWasmUrl: MOTOR_WASM
            });

            log("‚úÖ PRONTO! Toque em Ouvir.");

        } catch (erro) {
            log("‚ùå ERRO: " + erro.message);
            alert("Erro: " + erro.message + "\nVerifique sua internet!");
        }
    }

    // Fun√ß√µes dos Bot√µes
    window.tocar = async function() {
        if (!piper) { alert("Ainda carregando..."); return; }
        const texto = document.getElementById('texto').value;
        log("üîä Gerando √°udio...");
        try {
            const out = await piper.speak(texto);
            const blob = new Blob([out.rawHtml], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            const player = document.getElementById('player');
            player.style.display = 'block';
            player.src = url;
            player.play();
            log("‚ñ∂Ô∏è Reproduzindo");
        } catch (e) { log("Erro √°udio: " + e.message); }
    }

    window.baixar = async function() {
        if (!piper) return;
        const texto = document.getElementById('texto').value;
        log("üíæ Criando arquivo...");
        const out = await piper.speak(texto);
        const blob = new Blob([out.rawHtml], { type: 'audio/wav' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "audio.wav";
        a.click();
        log("‚úÖ Download iniciado");
    }

    // Inicia automaticamente
    iniciarSistema();
</script>

</body>
</html>
